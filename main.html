<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<style>
/* Header */
.header {
  display: flex;
  align-items: center;
  background-color: #004aad;
  color: white;
  padding: 12px;
  font-family: "Helvetica Neue", Arial, sans-serif;
}
.header h1 {
  margin: 0 0 0 10px;
  font-size: 20px;
  font-weight: 600;
}
.header button {
  font-size: 24px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
}

/* Chat area */
.messages {
  background: url('https://i.postimg.cc/260LPnbY/Generate-a-professional-chat-theme-wallpaper-I-can-use-for-my-app-I-created-colour-blue-with-numero.jpg');
  background-size: cover;
  opacity: 0.9; /* Slightly faded for readability */
  flex: 1;
  padding: 8px;
  overflow-y: auto;
  height: calc(100vh - 120px); /* header + input */
}

/* Chat bubbles */
.message {
  max-width: 70%;
  padding: 8px 12px;
  margin: 6px 0;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.4;
}
.sent {
  background-color: #dcf8c6;
  margin-left: auto;
}
.received {
  background-color: white;
  margin-right: auto;
}

/* Input area */
.input-area {
  display: flex;
  padding: 10px;
  background: #eee;
  border-top: 1px solid #ccc;
}
.input-area input {
  flex: 1;
  padding: 12px;
  border-radius: 20px;
  border: 1px solid #ccc;
  outline: none;
}
.input-area button {
  padding: 12px 16px;
  margin-left: 8px;
  background: #004aad;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <button onclick="goBack()">←</button>
  <h1 id="chatTitle">Chat</h1>
</div>

<!-- Messages area -->
<div id="messages" class="messages"></div>

<!-- Input area -->
<div class="input-area">
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button onclick="sendMessage()">➤</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAPvMmKigTlnSgi3qu7jwtRiFMAXJtxpHg",
  authDomain: "konnect-38667.firebaseapp.com",
  projectId: "konnect-38667"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Get logged-in user and active chat */
const myNumber = localStorage.getItem("konnect_phone");
const activeChat = localStorage.getItem("active_chat");
if(!myNumber || !activeChat){
    alert("No active chat. Returning to main.");
    window.location.href = "main.html";
}

/* Set chat title */
document.getElementById("chatTitle").textContent = activeChat;

/* Back button function */
function goBack() {
    window.location.href = "main.html";
}

/* Send message */
window.sendMessage = async () => {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if(!text) return;
    input.value = "";

    try {
        await addDoc(collection(db, "userChats", myNumber, "chats", activeChat, "messages"), {
            sender: myNumber,
            text: text,
            timestamp: serverTimestamp()
        });
    } catch(e){
        console.error("Error sending message:", e);
    }
};

/* Listen for messages in real-time */
const messagesDiv = document.getElementById("messages");
const q = query(collection(db, "userChats", myNumber, "chats", activeChat, "messages"), orderBy("timestamp"));
onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "message " + (data.sender===myNumber ? "sent" : "received");
        div.textContent = data.text;
        messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>

</body>
</html>
